generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ... existing models ...


model Chart {
  id               String             @id @default(cuid())
  createdAt        DateTime           @default(now())
  userEmail        String?
  birthDateTimeUtc DateTime?
  tzOffsetMinutes  Int?
  city             String?
  country          String?
  latitude         Float?
  longitude        Float?
  ascendant        Float?
  mc               Float?
  descendant       Float?
  ic               Float?
  risingSign       Sign?
  mcSign           Sign?
  descendantSign   Sign?
  icSign           Sign?
  sunSign          Sign?
  sunHouse         Int?
  moonSign         Sign?
  moonHouse        Int?
  mercurySign      Sign?
  mercuryHouse     Int?
  venusSign        Sign?
  venusHouse       Int?
  marsSign         Sign?
  marsHouse        Int?
  jupiterSign      Sign?
  jupiterHouse     Int?
  saturnSign       Sign?
  saturnHouse      Int?
  uranusSign       Sign?
  uranusHouse      Int?
  neptuneSign      Sign?
  neptuneHouse     Int?
  plutoSign        Sign?
  plutoHouse       Int?
  chartRulerPlanet Planet?
  chartRulerHouse  Int?
  northNodeHouse   Int?
  chironHouse      Int?
  rawChart         Json
  aspects          ChartAspect[]
  responses        Response[]
  surveys          Survey[]
  submissions      SurveySubmission[]

  @@index([userEmail, createdAt])
  @@index([risingSign])
  @@index([sunSign, moonSign, mercurySign])
  @@index([venusSign, marsSign])
  @@index([jupiterSign, saturnSign])
  @@index([uranusSign, neptuneSign, plutoSign])
}

model ChartAspect {
  id       String     @id @default(cuid())
  chartId  String
  a        Planet
  b        Planet
  aspect   AspectType
  orb      Float?
  strength Int?
  chart    Chart      @relation(fields: [chartId], references: [id], onDelete: Cascade)

  @@index([chartId, aspect])
}

model AscSignInterpretation {
  id     String  @id @default(cuid())
  sign   Sign    @unique
  title  String?
  body   String
  source String?
}

model ChartRulerSignInterpretation {
  id     String  @id @default(cuid())
  sign   Sign    @unique
  body   String
  source String?
}

model ChartRulerHouseInterpretation {
  id     String  @id @default(cuid())
  house  Int     @unique
  body   String
  source String?
}

model PlanetSignInterpretation {
  id     String  @id @default(cuid())
  planet Planet
  sign   Sign
  body   String
  source String?

  @@unique([planet, sign])
}

model PlanetHouseInterpretation {
  id     String  @id @default(cuid())
  planet Planet
  house  Int
  body   String
  source String?

  @@unique([planet, house])
}

model NodeHouseInterpretation {
  id     String  @id @default(cuid())
  node   String
  house  Int
  body   String
  source String?

  @@unique([node, house])
}

model ChironHouseInterpretation {
  id     String  @id @default(cuid())
  house  Int     @unique
  body   String
  source String?
}

model Survey {
  id        String     @id @default(cuid())
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  chartId   String?
  type      String?
  version   String?
  schema    Json?
  userEmail String?
  responses Response[]
  chart     Chart?     @relation(fields: [chartId], references: [id])

  @@index([userEmail, createdAt])
}

model Response {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  surveyId  String
  chartId   String?
  answers   Json
  userEmail String?
  chart     Chart?   @relation(fields: [chartId], references: [id])
  survey    Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([userEmail, createdAt])
}

model SurveySection {
  id        String           @id @default(cuid())
  key       String           @unique
  title     String
  sortOrder Int
  questions SurveyQuestion[]

  @@map("survey_sections")
}

model SurveyQuestion {
  id         String             @id @default(cuid())
  sectionId  String
  key        String             @unique
  text       String
  type       SurveyQuestionType
  sortOrder  Int
  showIfJson Json?
  options    SurveyOption[]
  section    SurveySection      @relation(fields: [sectionId], references: [id])
  responses  SurveyResponse[]

  @@map("survey_questions")
}

model SurveyOption {
  id              String                 @id @default(cuid())
  questionId      String
  value           String
  label           String
  sortOrder       Int
  question        SurveyQuestion         @relation(fields: [questionId], references: [id])
  responseOptions SurveyResponseOption[]

  @@map("survey_options")
}

model SurveyResponse {
  id              String                 @id @default(cuid())
  userId          String
  questionId      String
  submissionId    String?
  answerText      String?
  createdAt       DateTime               @default(now())
  responseOptions SurveyResponseOption[]
  question        SurveyQuestion         @relation(fields: [questionId], references: [id])
  submission      SurveySubmission?      @relation(fields: [submissionId], references: [id])

  @@index([questionId])
  @@index([submissionId])
  @@map("survey_responses")
}

model SurveyResponseOption {
  responseId String
  optionId   String
  option     SurveyOption   @relation(fields: [optionId], references: [id])
  response   SurveyResponse @relation(fields: [responseId], references: [id])

  @@id([responseId, optionId])
  @@map("survey_response_options")
}

model SurveySubmission {
  id        String           @id @default(cuid())
  userEmail String?
  chartId   String?
  fullData  Json?
  createdAt DateTime         @default(now())
  chart     Chart?           @relation(fields: [chartId], references: [id])
  responses SurveyResponse[]

  @@index([userEmail, createdAt])
}

model EmailOutbox {
  id           String    @id @default(cuid())
  toEmail      String
  subject      String
  htmlBody     String
  status       String    @default("PENDING")
  error        String?
  submissionId String?
  chartId      String?
  createdAt    DateTime  @default(now())
  sentAt       DateTime?
}

model Reading {
  id           String   @id @default(cuid())
  submissionId String   @unique
  chartId      String?
  userEmail    String?
  summary      String
  createdAt    DateTime @default(now())
}

enum Planet {
  Sun
  Moon
  Mercury
  Venus
  Mars
  Jupiter
  Saturn
  Uranus
  Neptune
  Pluto
}

enum Sign {
  Aries
  Taurus
  Gemini
  Cancer
  Leo
  Virgo
  Libra
  Scorpio
  Sagittarius
  Capricorn
  Aquarius
  Pisces
}

enum AspectType {
  Conjunction
  Sextile
  Square
  Trine
  Opposition
}

enum SurveyQuestionType {
  text
  radio
  checkbox
  slider
}
